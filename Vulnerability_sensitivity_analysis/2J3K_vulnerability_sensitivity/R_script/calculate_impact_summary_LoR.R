

calculate_impact_summary_LoR <- function(LoR_rename, F_data, species_unselect, LoR_obs_position, species, description = "name") {
  
  LoR_obs_position_2 <- LoR_obs_position
  
  df_group_impacted <- function(LoR_rename, F_data, species_unselect) {
    # Extract column names
    column_names <- paste0("LoR_", LoR_rename)
    
    # Filter F_data and rename columns
    Df_percentage <- F_data %>% 
      filter(!(Group_number %in% species_unselect)) %>%
      select(-c(Group_number, Group_name)) %>% 
      rename_at(vars(starts_with("b")), list(~ column_names)) %>%
      select(LoR_obs, LoR_1, LoR_10, LoR_20, LoR_30, 
             LoR_40, LoR_50, LoR_60, LoR_70, LoR_80, 
             LoR_90, LoR_100)
    
    # Convert selected columns to numeric
    Df_percentage <- as_tibble(Df_percentage) %>% mutate(across(everything(), as.numeric))
    
    # Calculate percentage changes
    percentage_changes <- Df_percentage %>%
      mutate(across(-LoR_obs, ~ ((. - LoR_obs) / abs(LoR_obs)) * 100)) %>%
      select(-LoR_obs)  # Retirer la colonne de référence après calcul
    
    # Create column for LoR_obs
    LoR_obs <- tibble(LoR_obs = rep(0, nrow(Df_percentage)))
    
    # Extract species names
    species_names <- F_data %>% filter(!(Group_number %in% species_unselect)) %>% pull(Group_name)
    
    # Combine dataframes, ensuring result_df is a tibble
    result_df <- bind_cols(LoR_obs, percentage_changes) %>% as_tibble() %>% dplyr::relocate(LoR_obs, .before = LoR_obs_position_2)
    
    return(list(result_df = result_df, species_names = species_names))
  }
  
  get_impacted_species <- function(df, species_names, threshold, sign) {
    df_change <- df %>%
      mutate(across(everything(), ~ case_when(
        . >= threshold & sign == "pos" ~ "+",
        . <= -threshold & sign == "neg" ~ "-",
        TRUE ~ "no"
      )))
    
    impacted_list <- lapply(names(df_change), function(col) {
      impacted <- species_names[df_change[[col]] %in% c("+", "-")]
      if (length(impacted) == 0) impacted <- "No change"
      return(paste(impacted, collapse = "; "))  # Séparateur ";"
    })
    
    return(impacted_list)
  }
  
  # Call df_group_impacted function
  impacted_data <- df_group_impacted(LoR_rename, F_data, species_unselect)
  result_df <- impacted_data$result_df
  species_names <- impacted_data$species_names
  
  # Étape 5 : Création du tableau récapitulatif
  result_table <- tibble(
    `LoR simulation` = c("LoR_obs (baseline)", names(result_df)),
    `20% change -` = c("No change", get_impacted_species(result_df, species_names, 20, "neg")),
    `20% change +` = c("No change", get_impacted_species(result_df, species_names, 20, "pos")),
    `40% change -` = c("No change", get_impacted_species(result_df, species_names, 40, "neg")),
    `40% change +` = c("No change", get_impacted_species(result_df, species_names, 40, "pos"))
  )
  
  # Étape 6 : Conversion des noms en numéros si description == "number"
  if (description == "number") {
    # Création d'un mapping nom -> numéro
    name_to_number <- setNames(F_data$Group_number, F_data$Group_name)
    
    # Fonction pour remplacer les noms par les numéros
    convert_to_numbers <- function(species_string) {
      if (species_string == "No change") return(species_string)
      species_vector <- unlist(strsplit(species_string, "; "))
      number_vector <- unname(name_to_number[species_vector])
      return(paste(number_vector, collapse = "; "))
    }
    
    # Appliquer la conversion sur toutes les colonnes contenant des espèces
    result_table <- result_table %>%
      mutate(across(-`LoR simulation`, ~ sapply(., convert_to_numbers)))
  }
  
  return(result_table[-1, ])
}


