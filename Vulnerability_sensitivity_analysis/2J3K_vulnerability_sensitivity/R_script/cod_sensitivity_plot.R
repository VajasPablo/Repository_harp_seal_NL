

cod_sensitivity_plot <- function(){

# Étape 1 : Transformer le jeu de données en format long
data_long <- Df_merged_cod_vulnerability %>%
  pivot_longer(cols = starts_with("biomass_annual_cod_V"), 
               names_to = "vulnerability", 
               values_to = "Biomass") %>%
  mutate(vulnerability = case_when(
    vulnerability == "biomass_annual_cod_V10_F0" ~ "V10",
    vulnerability == "biomass_annual_cod_V100_F0" ~ "V100",
    vulnerability == "biomass_annual_cod_V100000_F0" ~ "V100000"
  )) %>%
  filter(!is.na(vulnerability))  # Supprime V2 car c'est la référence

# Étape 2 : Ajouter une colonne de biomasse relative par rapport à V2
data_rescaled <- data_long %>%
  left_join(Df_merged_cod_vulnerability %>%
              select(Group_number, biomass_annual_cod_V2_F0) %>%
              rename(Biomass_V2 = biomass_annual_cod_V2_F0),
            by = "Group_number") %>%
  mutate(Biomass = as.numeric(Biomass),  # Convertir en numérique
         Biomass_V2 = as.numeric(Biomass_V2),
         Relative_Biomass = Biomass / Biomass_V2) %>%
  select(Group_name, vulnerability, Relative_Biomass)

# Étape 3 : Tracer le graphique
gplot <- ggplot(data_rescaled, aes(x = Relative_Biomass, y = reorder(Group_name, Relative_Biomass), color = vulnerability)) +
  geom_point(size = 4, alpha = 0.8) +  # Points visibles avec transparence légère
  geom_vline(xintercept = 1, linetype = "dashed", color = "black") +  # Ligne de référence à 1
  scale_x_continuous(limits = c(0.975, 1.025)) +  # Échelle de X
  scale_color_manual(values = c("V10" = "yellow3", "V100" = "orange2", "V100000" = "tomato")) +  # Couleurs fixes
  theme_minimal(base_size = 14) +  # Agrandir la police pour RMarkdown
  labs(title = "Sensitivity Analysis of Cod Biomass at F=0",
       x = "Relative Biomass Change (V2 simulation scaled at 1)",
       y = "Functional Groups",
       color = "Vulnerability Scenario") +
  theme(
    legend.position = "top",
    legend.title = element_text(size = 14, face = "bold"),
    legend.text = element_text(size = 12),
    axis.title.x = element_text(size = 14, face = "bold"),
    axis.title.y = element_text(size = 14, face = "bold"),
    axis.text = element_text(size = 12),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5)
  )

return(gplot)

}