

compare_sensitivity_analysis <- function(table1, table2, name1, name2, print_second_table = FALSE) {
  
  # Fonction pour transformer les espèces en listes d'entiers
  parse_species <- function(species_vector) {
    species_vector <- as.character(species_vector)  # Convertir en caractère au cas où
    species_vector <- species_vector[!is.na(species_vector)]  # Supprimer les NA
    return(map(species_vector, function(species_str) {
      if (species_str == "No change" | species_str == "") return(character(0))
      return(unlist(strsplit(species_str, "; ")))
    }))
  }
  
  # Appliquer la transformation sur les deux tables
  df1_parsed <- table1 %>%
    mutate(across(-`LoD simulation`, ~ parse_species(.)))
  
  df2_parsed <- table2 %>%
    mutate(across(-`LoD simulation`, ~ parse_species(.)))
  
  # Comparaison des espèces impactées cellule par cellule
  comparison_table <- df1_parsed %>%
    left_join(df2_parsed, by = "LoD simulation", suffix = c(paste0("_", name1), paste0("_", name2))) %>%
    rowwise() %>%
    mutate(
      `Added species 20% (-)` = paste(setdiff(unlist(get(paste0("20% change -_", name2))), unlist(get(paste0("20% change -_", name1)))), collapse = "; "),
      `Removed species 20% (-)` = paste(setdiff(unlist(get(paste0("20% change -_", name1))), unlist(get(paste0("20% change -_", name2)))), collapse = "; "),
      `Added species 20% (+)` = paste(setdiff(unlist(get(paste0("20% change +_", name2))), unlist(get(paste0("20% change +_", name1)))), collapse = "; "),
      `Removed species 20% (+)` = paste(setdiff(unlist(get(paste0("20% change +_", name1))), unlist(get(paste0("20% change +_", name2)))), collapse = "; "),
      `Added species 40% (-)` = paste(setdiff(unlist(get(paste0("40% change -_", name2))), unlist(get(paste0("40% change -_", name1)))), collapse = "; "),
      `Removed species 40% (-)` = paste(setdiff(unlist(get(paste0("40% change -_", name1))), unlist(get(paste0("40% change -_", name2)))), collapse = "; "),
      `Added species 40% (+)` = paste(setdiff(unlist(get(paste0("40% change +_", name2))), unlist(get(paste0("40% change +_", name1)))), collapse = "; "),
      `Removed species 40% (+)` = paste(setdiff(unlist(get(paste0("40% change +_", name1))), unlist(get(paste0("40% change +_", name2)))), collapse = "; ")
    ) %>%
    select(`LoD simulation`, 
           `Added species 20% (-)`, `Removed species 20% (-)`,
           `Added species 20% (+)`, `Removed species 20% (+)`,
           `Added species 40% (-)`, `Removed species 40% (-)`,
           `Added species 40% (+)`, `Removed species 40% (+)`)
  
  # Remplacer les valeurs vides par "No change"
  comparison_table[comparison_table == ""] <- "No change"
  
  # **NOUVELLE PARTIE : Comparaison des espèces globales**
  
  # Extraire toutes les espèces uniques de chaque tableau
  all_species_table1 <- unique(unlist(map(table1 %>% select(-`LoD simulation`), parse_species)))
  all_species_table2 <- unique(unlist(map(table2 %>% select(-`LoD simulation`), parse_species)))
  
  # Identifier les espèces complètement nouvelles et disparues
  new_species <- setdiff(all_species_table2, all_species_table1)
  disappeared_species <- setdiff(all_species_table1, all_species_table2)
  
  # Ajouter cette information au tableau de comparaison sous forme d’un tibble séparé
  summary_species_changes <- tibble(
    `New species in analysis` = ifelse(length(new_species) > 0, paste(new_species, collapse = "; "), "No new species"),
    `Disappeared species in analysis` = ifelse(length(disappeared_species) > 0, paste(disappeared_species, collapse = "; "), "No disappeared species")
  )
  
  # Affichage conditionnel si print_second_table == TRUE
  if (print_second_table) {
    print(summary_species_changes)
  }
  
  # Retourner les résultats
  return(list(Comparison_by_cell = comparison_table, Global_species_changes = summary_species_changes))
}
