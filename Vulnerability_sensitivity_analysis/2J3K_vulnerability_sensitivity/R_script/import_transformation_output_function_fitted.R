

import_transformation_output_function_fitted <- function(species, version, F_or_B, F_vector = NULL, print = FALSE) {
  
  # Définition du dossier source des fichiers selon l'espèce
  species_folder <- switch(species,
                           "cod" = "cod_sim",
                           "capelin" = "capelin_sim",
                           "harp_seal" = "harp_seal_sim",
                           stop("Espèce non reconnue")
  )
  
  # Si F_vector n'est pas fourni, on le déduit des fichiers existants
  if (is.null(F_vector)) {
    all_files <- list.files(here(species_folder), pattern = paste0("biomass_annual_fitted_", version, "_", species, "_", F_or_B), full.names = TRUE)
    F_vector <- unique(gsub(".*_F([0-9\\.]+)\\.xlsx$", "\\1", basename(all_files)))
  }
  
  # Génération dynamique des noms de fichiers
  file_list <- paste0("biomass_annual_fitted_", version, "_", species, "_", F_or_B, F_vector, ".xlsx")
  
  # Construction du chemin complet des fichiers
  file_paths <- file.path(here(species_folder), file_list)
  
  # Vérifier quels fichiers existent réellement avant de les importer
  existing_files <- file_paths[file.exists(file_paths)]
  
  if (length(existing_files) == 0) {
    stop("Aucun fichier trouvé pour ", species, " version ", version, " ", F_or_B)
  }
  
  # Lire les fichiers existants
  all_data <- lapply(existing_files, openxlsx::read.xlsx)
  
  # Transformation des données
  list_of_dataframes <- map2(all_data, existing_files, function(simulation_data, file_path) {
    
    # Extraire un nom de variable unique à partir du nom de fichier
    var_name <- gsub(".xlsx", "", basename(file_path))
    
    # Transformer la table
    simulation_data <- simulation_data %>% 
      filter(row_number() %in% c(8, n())) %>% 
      t() %>% 
      as_tibble() %>%
      rename(Group_number = V1, !!var_name := V2) %>% 
      slice(-1) %>%
      mutate(Group_number = as.integer(Group_number))
    
    return(simulation_data)
  })
  
  # Fusionner tous les fichiers
  Df_merged <- reduce(list_of_dataframes, left_join, by = "Group_number") %>%
    left_join(group_name_key, by = "Group_number")  # Assure-toi que `group_name_key` est disponible
  
  # Stocker dans l'environnement global
  assign(paste0("Df_merged_fitted_", species, "_", version, "_", F_or_B), Df_merged, envir = .GlobalEnv)
  
  # Optionnel : afficher le résultat
  if (print) {
    print(Df_merged)
  }
}
