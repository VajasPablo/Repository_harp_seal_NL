---
title: "EwE 2018-2020 3LNO (South part) - vulnerability sensitivity analysis"
author: "Vajas Pablo"
date: ' `r Sys.Date()` '
output:
  html_document: 
    toc: true
    toc_float: true
    number_sections: true
editor_options: 
  chunk_output_type: console
link-citations: true
---
```{r setup, include=FALSE, cache=FALSE}

knitr::opts_chunk$set(
    echo = FALSE,
    include = FALSE,
    fig.width = 12,
    fig.height = 8,
    fig.path = "R_figures_export/",
    message = FALSE,
    warning = FALSE,
    dev = c("png", "pdf")
)

# options(device = "quartz")

```

```{r package}

install_and_load_packages <- function() {
  # List of packages to be installed and loaded
  packages <- c("tidyverse", "gridExtra", "knitr", "writexl", "openxlsx", "here", "scales", "DT")
  
  # Function to install and load a package
  install_and_load <- function(package_name) {
    if (!requireNamespace(package_name, quietly = TRUE)) {
      message(paste("Package", package_name, "is not installed. Installing..."))
      install.packages(package_name, dependencies = TRUE)
    }
    message(paste("Loading package", package_name, "..."))
    suppressMessages(library(package_name, character.only = TRUE))
  }
  
  # Loop through the list of packages
  for (pkg_name in packages) {
    install_and_load(pkg_name)
  }
}

# Call the function to install and load packages
install_and_load_packages()

```

```{r source}

sapply(list.files(here("R_script"), pattern="*.R", full.names=TRUE, ignore.case=TRUE),source,.GlobalEnv)

```

# Does the cod's vulnerability allow it to increase its abundance sufficiently at F=0? 

```{r cod_vuln_vs_biomass, include=TRUE, echo=FALSE}

import_transformation_output_function_cod()

cod_sensitivity_plot()

```

# First approach: run all simulations fitted at V=2, then re-run them with harp seal V=4 unfitted LoD

```{r import, echo = FALSE, include=TRUE}

import_transformation_output_function("cod", "V2", "F")
import_transformation_output_function("cod", "V2", "B")

import_transformation_output_function("cod", "V4", "F")
import_transformation_output_function("cod", "V4", "B")

import_transformation_output_function("cod", "V10", "F")
import_transformation_output_function("cod", "V10", "B")

import_transformation_output_function("capelin", "V2", "F")
import_transformation_output_function("capelin", "V2", "B")

import_transformation_output_function("capelin", "V4", "F")
import_transformation_output_function("capelin", "V4", "B")

import_transformation_output_function("capelin", "V10", "F")
import_transformation_output_function("capelin", "V10", "B")

import_transformation_output_function("harp_seal", "V2", "F")
import_transformation_output_function("harp_seal", "V4", "F")
import_transformation_output_function("harp_seal", "V10", "F")

```

## Cod and Capelin biomass versus Harp seal vulnerability change {.tabset}

### Note

The present simulations are analogous to those of Vajas et al., but with three values of v (vulnerability) for 'harp seal' (applied to the harp seal column for all predated species). The figures and tables present a comparison of the proportion of change between the default baseline of v=2 and the other v values (implying a more top-down effect from harp seal on the ecosystem).

### Cod simulation : F scenario V=2 versus V=4

```{r cod_F_2_4, include = TRUE, echo = FALSE}

comparison_cod_F_2_4 <- compare_sensitivity(Df_merged_cod_V2_F, Df_merged_cod_V4_F)

plot_simulation_comparison(comparison_cod_F_2_4, "LoD", 11, " F Cod Simulation: harp seal scenario V=2 vs V=4", group_name_key, sp_remove = c("Atlantic cod greater than 35cm", "Atlantic cod less than 35cm"),
                legend_labels = paste0("LoD ", c(0,10,20,30,40,50,60,70,80,90,99)))

datatable(comparison_cod_F_2_4, filter = "top", rownames = FALSE, options = list(pageLength = 5,  scrollX=T))

```

### Cod simulation : F scenario V=2 versus V=10

```{r cod_F_2_10, include = TRUE, echo = FALSE}

comparison_cod_F_2_10 <- compare_sensitivity(Df_merged_cod_V2_F, Df_merged_cod_V10_F)

plot_simulation_comparison(comparison_cod_F_2_10, "LoD", 11, "F Cod Simulation: harp seal scenario V=2 vs V=10", group_name_key, sp_remove = c("Atlantic cod greater than 35cm", "Atlantic cod less than 35cm"),
                legend_labels = paste0("LoD ", c(0,10,20,30,40,50,60,70,80,90,99)))

datatable(comparison_cod_F_2_10, filter = "top", rownames = FALSE, options = list(pageLength = 5,  scrollX=T))

```

### Caplin simulation : F scenario V=2 versus V=4

```{r capelin_F_2_4, include = TRUE, echo = FALSE}

comparison_capelin_F_2_4 <- compare_sensitivity(Df_merged_capelin_V2_F, Df_merged_capelin_V4_F)

plot_simulation_comparison(comparison_capelin_F_2_4, "LoD", 11, "F Capelin Simulation: harp seal scenario V=2 vs V=4", group_name_key, sp_remove = c("Capelin"),
                legend_labels = paste0("LoD ", c(0,10,20,30,40,50,60,70,80,90,99)))

datatable(comparison_capelin_F_2_4, filter="top", rownames = FALSE, options = list(pageLength = 5, scrollX=T))

```

### Caplin simulation : F scenario V=2 versus V=10

```{r capelin_F_2_10, include = TRUE, echo = FALSE}

comparison_capelin_F_2_10 <- compare_sensitivity(Df_merged_capelin_V2_F, Df_merged_capelin_V10_F)

plot_simulation_comparison(comparison_capelin_F_2_10, "LoD", 11, "F Capelin Simulation: harp seal scenario V=2 vs V=10", group_name_key, sp_remove = c("Capelin"),
                legend_labels = paste0("LoD ", c(0,10,20,30,40,50,60,70,80,90,99)))

datatable(comparison_capelin_F_2_10, filter="top", rownames = FALSE, options = list(pageLength = 5, scrollX=T))

```

### Harp seal simulation : F scenario V=2 versus V=4

```{r seal_F_2_4, include = TRUE, echo = FALSE}

comparison_harp_seal_F_2_4 <- compare_sensitivity(Df_merged_harp_seal_V2_F, Df_merged_harp_seal_V4_F)

plot_simulation_comparison(comparison_harp_seal_F_2_4, "LoD", 11, "F Harp Seal Simulation: harp seal scenario V=2 vs V=4", group_name_key, sp_remove = c("Seal harp"),
                legend_labels = paste0("LoD ", c(0,10,20,30,40,50,60,70,80,90,99)))

datatable(comparison_harp_seal_F_2_4, filter="top", rownames = FALSE, options = list(pageLength = 15, scrollX=T))

```

### Harp seal simulation : F scenario V=2 versus V=10

```{r seal_F_2_10, include = TRUE, echo = FALSE}

comparison_harp_seal_F_2_10 <- compare_sensitivity(Df_merged_harp_seal_V2_F, Df_merged_harp_seal_V10_F)

plot_simulation_comparison(comparison_harp_seal_F_2_10, "LoD", 11, "F Harp Seal Simulation: harp seal scenario V=2 vs V=10", group_name_key, sp_remove = c("Seal harp"),
                legend_labels = paste0("LoD ", c(0,10,20,30,40,50,60,70,80,90,99)))

datatable(comparison_harp_seal_F_2_10, filter="top", rownames = FALSE, options = list(pageLength = 15, scrollX=T))

```


### Harp seal trends between V=2, V=4, V=10

```{r seal_trends, include = TRUE, echo = FALSE}

harp_seal_trends()

```

# Group. Impacted 

## F Cod simulation : harp seal vulnerability change {.tabset}

### Blank 

### Default results V=2

```{r f_cod_defaut, include=TRUE, echo=FALSE}

# Test avec tes données corrigées
table_Df_merged_cod_V2_F <- calculate_impact_summary(
  LoD_rename = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 99),
  F_data = Df_merged_cod_V2_F,
  species_unselect = c(12,13),
  species = "Cod",
  description = "number"
)

# Affichage interactif
datatable(table_Df_merged_cod_V2_F, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```

### Results with V=4

```{r f_cod_V4, include=TRUE, echo=FALSE}

# Test avec tes données corrigées
table_Df_merged_cod_V4_F <- calculate_impact_summary(
  LoD_rename = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 99),
  F_data = Df_merged_cod_V4_F,
  species_unselect = c(12,13),
  species = "Cod",
  description = "number"
)

# Affichage interactif
datatable(table_Df_merged_cod_V4_F, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```

### Results with V=10

```{r f_cod_V10, include=TRUE, echo=FALSE}

# Test avec tes données corrigées
table_Df_merged_cod_V10_F <- calculate_impact_summary(
  LoD_rename = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 99),
  F_data = Df_merged_cod_V10_F,
  species_unselect = c(12,13),
  species = "Cod",
  description = "number"
)

# Affichage interactif
datatable(table_Df_merged_cod_V10_F, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```

### Changes between V2 and V4

```{r f_cod_V2_V4, include=TRUE, echo=FALSE}

comparison_cod_V2_V4 <- compare_sensitivity_analysis(table_Df_merged_cod_V2_F, table_Df_merged_cod_V4_F, "V2", "V4")
datatable(comparison_cod_V2_V4$Comparison_by_cell, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```

### Changes between V2 and V10

```{r f_cod_V2_V10, include=TRUE, echo=FALSE}

comparison_cod_V2_V10 <- compare_sensitivity_analysis(table_Df_merged_cod_V2_F, table_Df_merged_cod_V10_F, "V2", "V10")
datatable(comparison_cod_V2_V10$Comparison_by_cell, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```

## F capelin simulation : harp seal vulnerability change {.tabset}

### Blank 

### Default results V=2

```{r f_capelin_defaut, include=TRUE, echo=FALSE}

# Test avec tes données corrigées
table_Df_merged_capelin_V2_F <- calculate_impact_summary(
  LoD_rename = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 99),
  F_data = Df_merged_capelin_V2_F,
  species_unselect = c(31),
  species = "capelin",
  description = "number"
)

# Affichage interactif
datatable(table_Df_merged_capelin_V2_F, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```

### Results with V=4

```{r f_capelin_V4, include=TRUE, echo=FALSE}

# Test avec tes données corrigées
table_Df_merged_capelin_V4_F <- calculate_impact_summary(
  LoD_rename = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 99),
  F_data = Df_merged_capelin_V4_F,
  species_unselect = c(31),
  species = "capelin",
  description = "number"
)

# Affichage interactif
datatable(table_Df_merged_capelin_V4_F, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```

### Results with V=10

```{r f_capelin_V10, include=TRUE, echo=FALSE}

# Test avec tes données corrigées
table_Df_merged_capelin_V10_F <- calculate_impact_summary(
  LoD_rename = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 99),
  F_data = Df_merged_capelin_V10_F,
  species_unselect = c(31),
  species = "capelin",
  description = "number"
)

# Affichage interactif
datatable(table_Df_merged_capelin_V10_F, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```

### Changes between V2 and V4

```{r f_capelin_V2_V4, include=TRUE, echo=FALSE}

comparison_capelin_V2_V4 <- compare_sensitivity_analysis(table_Df_merged_capelin_V2_F, table_Df_merged_capelin_V4_F, "V2", "V4")
datatable(comparison_capelin_V2_V4$Comparison_by_cell, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```

### Changes between V2 and V10

```{r f_capelin_V2_V10, include=TRUE, echo=FALSE}

comparison_capelin_V2_V10 <- compare_sensitivity_analysis(table_Df_merged_capelin_V2_F, table_Df_merged_capelin_V10_F, "V2", "V10")
datatable(comparison_capelin_V2_V10$Comparison_by_cell, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```

## F Harp seal simulation : harp seal vulnerability change {.tabset}

### Blank

### Default results V=2

```{r f_harp_seal_defaut, include=TRUE, echo=FALSE}

# Test avec tes données corrigées
table_Df_merged_harp_seal_V2_F <- calculate_impact_summary(
  LoD_rename = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 99),
  F_data = Df_merged_harp_seal_V2_F,
  species_unselect = c(5),
  species = "harp_seal",
  description = "number"
)

# Affichage interactif
datatable(table_Df_merged_harp_seal_V2_F, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```

### Results with V=4

```{r f_harp_seal_V4, include=TRUE, echo=FALSE}

# Test avec tes données corrigées
table_Df_merged_harp_seal_V4_F <- calculate_impact_summary(
  LoD_rename = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 99),
  F_data = Df_merged_harp_seal_V4_F,
  species_unselect = c(5),
  species = "harp_seal",
  description = "number"
)

# Affichage interactif
datatable(table_Df_merged_harp_seal_V4_F, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```

### Results with V=10

```{r f_harp_seal_V10, include=TRUE, echo=FALSE}

# Test avec tes données corrigées
table_Df_merged_harp_seal_V10_F <- calculate_impact_summary(
  LoD_rename = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 99),
  F_data = Df_merged_harp_seal_V10_F,
  species_unselect = c(5),
  species = "harp_seal",
  description = "number"
)

# Affichage interactif
datatable(table_Df_merged_harp_seal_V10_F, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```

### Changes between V2 and V4

```{r f_harp_seal_V2_V4, include=TRUE, echo=FALSE}

comparison_harp_seal_V2_V4 <- compare_sensitivity_analysis(table_Df_merged_harp_seal_V2_F, table_Df_merged_harp_seal_V4_F, "V2", "V4")
datatable(comparison_harp_seal_V2_V4$Comparison_by_cell, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```

### Changes between V2 and V10

```{r f_harp_seal_V2_V10, include=TRUE, echo=FALSE}

comparison_harp_seal_V2_V10 <- compare_sensitivity_analysis(table_Df_merged_harp_seal_V2_F, table_Df_merged_harp_seal_V10_F, "V2", "V10")
datatable(comparison_harp_seal_V2_V10$Comparison_by_cell, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```


# Second approach: run all simulations fitted at V=2, then re-run them with harp seal V=4 fitted new LoD scale.

In the first approach, we applied changes in V to the exact simulations proposed in Vajas et al. However, although we ran the simulations with the same values of F, the correspondence between [F and LoD for v=2] and [F and LoD for V=4 or 10] is not the same. Here, for the column of harp seals at V=4 and V=10, we respectively recalculate the exact LoD values 0%, 10%, 20%, etc. So here we compare a true LoD 10% (v=2) with another true LoD 10% (V=4 and V=10).

## New LoD approximation {.tabset}

```{r second_import, include=TRUE, echo=FALSE}

Biomass_Harp_Seal = 0.652*0.4
Biomass_cod = 0.568 + 0.05214892
Biomass_Capelin = 3.5

import_transformation_output_function_fitted("cod", "V4", "F", F_vector = seq(0,0.5, by = 0.05), print = FALSE)
import_transformation_output_function_fitted("cod", "V10", "F", F_vector = seq(0,0.5, by = 0.05), print = FALSE)

import_transformation_output_function_fitted("capelin", "V4", "F", F_vector = seq(0, 0.8, by = 0.05), print = FALSE)
import_transformation_output_function_fitted("capelin", "V10", "F", F_vector = seq(0, 0.8, by = 0.05), print = FALSE)

import_transformation_output_function_fitted("harp_seal", "V4", "F", F_vector = seq(0, 0.22, by = 0.02), print = FALSE)
import_transformation_output_function_fitted("harp_seal", "V10", "F", F_vector = seq(0, 0.22, by = 0.02), print = FALSE)

```

### Blank

### Cod LoD check, harp seal v = 4

```{r cod_lod_check_V4,include=TRUE, echo=FALSE}

Df_merged_fitted_cod_V4_F  <- Df_merged_fitted_cod_V4_F %>%
  mutate(across(starts_with("biomass"), as.numeric)) %>%
  filter(Group_number %in% c(12, 13)) %>%
  mutate(
    across(starts_with("biomass"), ~ sum(.)),
    Group_number = 46,
    Group_name = "Cod"
  ) %>%
  slice(1) %>%
  rbind.data.frame(Df_merged_fitted_cod_V4_F) %>%
  arrange(Group_number)

LoD_check_plot_approx(
  data = Df_merged_fitted_cod_V4_F,
  observed_biomass = Biomass_cod,
  Fspecies = "Fcod",
  species = "Cod",
  species_chrc = "cod",
  version = "V4",
  Group_number_specific = 46
)

datatable(data = Df_LoD_fixed_cod_V4, filter="top", 
          rownames = FALSE, options = list(pageLength = 5, scrollX=T))


```

### Cod, harp seal v = 10

```{r cod_lod_check_V10,include=TRUE, echo=FALSE}


Df_merged_fitted_cod_V10_F  <- Df_merged_fitted_cod_V10_F %>%
  mutate(across(starts_with("biomass"), as.numeric)) %>%
  filter(Group_number %in% c(12, 13)) %>%
  mutate(
    across(starts_with("biomass"), ~ sum(.)),
    Group_number = 46,
    Group_name = "Cod"
  ) %>%
  slice(1) %>%
  rbind.data.frame(Df_merged_fitted_cod_V10_F) %>%
  arrange(Group_number)

LoD_check_plot_approx(
  data = Df_merged_fitted_cod_V10_F,
  observed_biomass = Biomass_cod,
  Fspecies = "Fcod",
  species = "Cod",
  species_chrc = "cod",
  version = "V10",
  Group_number_specific = 46
)

datatable(data = Df_LoD_fixed_cod_V10, filter="top", 
          rownames = FALSE, options = list(pageLength = 5, scrollX=T))


```

### Capelin, harp seal v = 4

```{r capelin_lod_check_V4,include=TRUE, echo=FALSE}


LoD_check_plot_approx(
  data = Df_merged_fitted_capelin_V4_F,  
  observed_biomass = Biomass_Capelin,
  Fspecies = "Fcapelin",
  species = "Capelin",
  species_chrc = "capelin",
  version = "V4",  
  Group_number_specific = 31
)

# Affichage interactif du DataFrame résultant
datatable(
  data = Df_LoD_fixed_capelin_V4, 
  filter = "top",
  rownames = FALSE,
  options = list(pageLength = 5, scrollX = TRUE)
)


```

### Capelin, harp seal v = 10

```{r capelin_lod_check_V10,include=TRUE, echo=FALSE}

LoD_check_plot_approx(
  data = Df_merged_fitted_capelin_V10_F,  
  observed_biomass = Biomass_Capelin,
  Fspecies = "Fcapelin",
  species = "Capelin",
  species_chrc = "capelin",
  version = "V10",  
  Group_number_specific = 31
)

# Affichage interactif du DataFrame résultant
datatable(
  data = Df_LoD_fixed_capelin_V10, 
  filter = "top",
  rownames = FALSE,
  options = list(pageLength = 5, scrollX = TRUE)
)

```

### Harp seal, harp seal v = 4

```{r seal_lod_check_V4,include=TRUE, echo=FALSE}

LoD_check_plot_approx(
  data = Df_merged_fitted_harp_seal_V4_F,
  observed_biomass = Biomass_Harp_Seal,
  Fspecies = "Fseal",
  species = "Harp seal",
  species_chrc = "harp_seal",
  version = "V4",
  Group_number_specific = 5
)

datatable(data = Df_LoD_fixed_harp_seal_V4, filter="top", 
          rownames = FALSE, options = list(pageLength = 5, scrollX=T))


```

### Harp seal, harp seal v = 10

```{r seal_lod_check_V10,include=TRUE, echo=FALSE}

LoD_check_plot_approx(
  data = Df_merged_fitted_harp_seal_V10_F,
  observed_biomass = Biomass_Harp_Seal,
  Fspecies = "Fseal",
  species = "Harp seal",
  species_chrc = "harp_seal",
  version = "V10",
  Group_number_specific = 5
)

datatable(data = Df_LoD_fixed_harp_seal_V10, filter="top", 
          rownames = FALSE, options = list(pageLength = 5, scrollX=T))

```

## New LoD simulalations {.tabset}

```{r fix_mortality_value,include=TRUE, echo=FALSE}

F_Harp_seal_mortality = 0.02684049
F_Cod_mortality = 0.0317992
F_Capelin_mortality = 0.0055428

```

### Note 

Here, after finding all the F value for LoD value matches, we run the final simulations.

### Cod reference table 

```{r cod_reference, include=TRUE, echo=FALSE}

datatable(table_Df_merged_cod_V2_F, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```

### Cod, harp seal V=4

```{r cod_lod_new_V4,include=TRUE, echo=FALSE}

simulation_generate_function(
  simulation_names = paste0("new_Fcod_", Df_LoD_fixed_cod_V4 %>% 
                                        filter(Fixed_LoD %in% c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 99)) %>%
                                        select(F_mortality_interpolated) %>%
                                        unlist()), 
  Weight = 1,   
  Group_no = 12,
  Type = 4,     
  time_step_start = 1, 
  nb_time_steps = 100, 
  fill_value_min = F_Cod_mortality, 
  fill_value_max = Df_LoD_fixed_cod_V4 %>% 
                                        filter(Fixed_LoD %in% c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 99)) %>%
                                        select(F_mortality_interpolated) %>%
                                        unlist(),
  output_file = here("Simulation_input", "Cod_input_V4_simulation.csv"))

import_transformation_output_function_new("cod", "V4", "F")

table_Df_merged_new_cod_V4_F <- calculate_impact_summary(
  LoD_rename = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 99),
  F_data = Df_merged_new_cod_V4_F,
  species_unselect = c(12,13),
  species = "Cod",
  description = "number"
)

datatable(table_Df_merged_new_cod_V4_F, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```

### Cod, harp seal V=10

```{r cod_lod_new_V10,include=TRUE, echo=FALSE}

simulation_generate_function(
  simulation_names = paste0("new_Fcod_", Df_LoD_fixed_cod_V10 %>% 
                                        filter(Fixed_LoD %in% c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 99)) %>%
                                        select(F_mortality_interpolated) %>%
                                        unlist()), 
  Weight = 1,   
  Group_no = 12,
  Type = 4,     
  time_step_start = 1, 
  nb_time_steps = 100, 
  fill_value_min = F_Cod_mortality, 
  fill_value_max = Df_LoD_fixed_cod_V10 %>% 
                                        filter(Fixed_LoD %in% c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 99)) %>%
                                        select(F_mortality_interpolated) %>%
                                        unlist(),
  output_file = here("Simulation_input", "Cod_input_V10_simulation.csv"))

import_transformation_output_function_new("cod", "V10", "F")

table_Df_merged_new_cod_V10_F <- calculate_impact_summary(
  LoD_rename = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 99),
  F_data = Df_merged_new_cod_V10_F,
  species_unselect = c(12,13),
  species = "Cod",
  description = "number"
)

datatable(table_Df_merged_new_cod_V10_F, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```

### Cod, Changes between V2 and V4

```{r cod_new_V2_V4, include=TRUE, echo=FALSE}

comparison_new_fig_cod_V2_V4 <- compare_sensitivity(Df_merged_cod_V2_F, Df_merged_new_cod_V4_F)
plot_simulation_comparison(comparison_new_fig_cod_V2_V4, "LoD", 11, " F Cod Simulation: harp seal scenario V=2 vs V=4", group_name_key, sp_remove = c("Atlantic cod greater than 35cm", "Atlantic cod less than 35cm"),
                legend_labels = paste0("LoD ", c(0,10,20,30,40,50,60,70,80,90,99)))
datatable(comparison_new_fig_cod_V2_V4, filter = "top", rownames = FALSE, options = list(pageLength = 5,  scrollX=T))

comparison_new_cod_V2_V4 <- compare_sensitivity_analysis(table_Df_merged_cod_V2_F, table_Df_merged_new_cod_V4_F, "V2", "V4")
datatable(comparison_new_cod_V2_V4$Comparison_by_cell, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```

### Cod, Changes between V2 and V10

```{r cod_new_V2_V10, include=TRUE, echo=FALSE}

comparison_new_fig_cod_V2_V10 <- compare_sensitivity(Df_merged_cod_V2_F, Df_merged_new_cod_V10_F)
plot_simulation_comparison(comparison_new_fig_cod_V2_V10, "LoD", 11, " F Cod Simulation: harp seal scenario V=2 vs V=10", group_name_key, sp_remove = c("Atlantic cod greater than 35cm", "Atlantic cod less than 35cm"),
                legend_labels = paste0("LoD ", c(0,10,20,30,40,50,60,70,80,90,99)))
datatable(comparison_new_fig_cod_V2_V10, filter = "top", rownames = FALSE, options = list(pageLength = 5,  scrollX=T))

comparison_new_cod_V2_V10 <- compare_sensitivity_analysis(table_Df_merged_cod_V2_F, table_Df_merged_new_cod_V10_F, "V2", "V10")
datatable(comparison_new_cod_V2_V10$Comparison_by_cell, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```

### Capelin reference table 

```{r capelin_reference, include=TRUE, echo=FALSE}

datatable(table_Df_merged_capelin_V2_F, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```

### Capelin, harp seal V=4

```{r capelin_lod_new_V4,include=TRUE, echo=FALSE}

simulation_generate_function(
  simulation_names = paste0("new_Fcapelin_", Df_LoD_fixed_capelin_V4 %>% 
                                        filter(Fixed_LoD %in% c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 99)) %>%
                                        select(F_mortality_interpolated) %>%
                                        unlist()), 
  Weight = 1,   
  Group_no = 31,
  Type = 4,     
  time_step_start = 1, 
  nb_time_steps = 100, 
  fill_value_min = F_Capelin_mortality, 
  fill_value_max = Df_LoD_fixed_capelin_V4 %>% 
                                        filter(Fixed_LoD %in% c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 99)) %>%
                                        select(F_mortality_interpolated) %>%
                                        unlist(),
  output_file = here("Simulation_input", "Capelin_input_V4_simulation.csv"))

import_transformation_output_function_new("capelin", "V4", "F")

table_Df_merged_new_capelin_V4_F <- calculate_impact_summary(
  LoD_rename = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 99),
  F_data = Df_merged_new_capelin_V4_F,
  species_unselect = c(31),
  species = "capelin",
  description = "number"
)

datatable(table_Df_merged_new_capelin_V4_F, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```

### Capelin, harp seal V=10

```{r capelin_lod_new_V10,include=TRUE, echo=FALSE}

simulation_generate_function(
  simulation_names = paste0("new_Fcapelin_", Df_LoD_fixed_capelin_V10 %>% 
                                        filter(Fixed_LoD %in% c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 99)) %>%
                                        select(F_mortality_interpolated) %>%
                                        unlist()), 
  Weight = 1,   
  Group_no = 31,
  Type = 4,     
  time_step_start = 1, 
  nb_time_steps = 100, 
  fill_value_min = F_Capelin_mortality, 
  fill_value_max = Df_LoD_fixed_capelin_V10 %>% 
                                        filter(Fixed_LoD %in% c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 99)) %>%
                                        select(F_mortality_interpolated) %>%
                                        unlist(),
  output_file = here("Simulation_input", "Capelin_input_V10_simulation.csv"))


import_transformation_output_function_new("capelin", "V10", "F")

table_Df_merged_new_capelin_V10_F <- calculate_impact_summary(
  LoD_rename = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 99),
  F_data = Df_merged_new_capelin_V10_F,
  species_unselect = c(31),
  species = "capelin",
  description = "number"
)

datatable(table_Df_merged_new_capelin_V10_F, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```

### Capelin, Changes between V2 and V4

```{r capelin_new_V2_V4, include=TRUE, echo=FALSE}

comparison_new_fig_capelin_V2_V4 <- compare_sensitivity(Df_merged_capelin_V2_F, Df_merged_new_capelin_V4_F)

plot_simulation_comparison(comparison_new_fig_capelin_V2_V4, "LoD", 11, " F Capelin Simulation: harp seal scenario V=2 vs V=4", group_name_key, sp_remove = c("Capelin"),
                legend_labels = paste0("LoD ", c(0,10,20,30,40,50,60,70,80,90,99)))

datatable(comparison_new_fig_capelin_V2_V4, filter = "top", rownames = FALSE, options = list(pageLength = 5,  scrollX=T))

comparison_new_capelin_V2_V4 <- compare_sensitivity_analysis(table_Df_merged_capelin_V2_F, table_Df_merged_new_capelin_V4_F, "V2", "V4")
datatable(comparison_new_capelin_V2_V4$Comparison_by_cell, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```

### Capelin, Changes between V2 and V10

```{r capelin_new_V2_V10, include=TRUE, echo=FALSE}

comparison_new_fig_capelin_V2_V10 <- compare_sensitivity(Df_merged_capelin_V2_F, Df_merged_new_capelin_V10_F)
plot_simulation_comparison(comparison_new_fig_capelin_V2_V10, "LoD", 11, " F Capelin Simulation: harp seal scenario V=2 vs V=10", group_name_key, sp_remove = c("Capelin"),
                legend_labels = paste0("LoD ", c(0,10,20,30,40,50,60,70,80,90,99)))
datatable(comparison_new_fig_capelin_V2_V10, filter = "top", rownames = FALSE, options = list(pageLength = 5,  scrollX=T))

comparison_new_capelin_V2_V10 <- compare_sensitivity_analysis(table_Df_merged_capelin_V2_F, table_Df_merged_new_capelin_V10_F, "V2", "V10")
datatable(comparison_new_capelin_V2_V10$Comparison_by_cell, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```

### Harp seal reference table 

```{r seal_reference, include=TRUE, echo=FALSE}

datatable(table_Df_merged_harp_seal_V2_F, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```


### Harp seal, Harp seal V=4

```{r seal_new_V4, include=TRUE, echo=FALSE}

simulation_generate_function(
  simulation_names = paste0("new_Fseal_", Df_LoD_fixed_harp_seal_V4 %>% 
                                        filter(Fixed_LoD %in% c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 99)) %>%
                                        select(F_mortality_interpolated) %>%
                                        unlist()), 
  Weight = 1,   
  Group_no = 5,
  Type = 4,     
  time_step_start = 1, 
  nb_time_steps = 100, 
  fill_value_min = F_Harp_seal_mortality, 
  fill_value_max = Df_LoD_fixed_harp_seal_V4 %>% 
                                        filter(Fixed_LoD %in% c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 99)) %>%
                                        select(F_mortality_interpolated) %>%
                                        unlist(),
  output_file = here("Simulation_input", "Harp_seal_input_V4_simulation.csv"))


import_transformation_output_function_new("harp_seal", "V4", "F")

table_Df_merged_new_harp_seal_V4_F <- calculate_impact_summary(
  LoD_rename = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 99),
  F_data = Df_merged_new_harp_seal_V4_F,
  species_unselect = c(5),
  species = "harp_seal",
  description = "number"
)

datatable(table_Df_merged_new_harp_seal_V4_F, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```

### harp seal, Harp seal V=10

```{r seal_new_V10, include=TRUE, echo=FALSE}

simulation_generate_function(
  simulation_names = paste0("new_Fseal_", Df_LoD_fixed_harp_seal_V10 %>% 
                                        filter(Fixed_LoD %in% c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 99)) %>%
                                        select(F_mortality_interpolated) %>%
                                        unlist()), 
  Weight = 1,   
  Group_no = 5,
  Type = 4,     
  time_step_start = 1, 
  nb_time_steps = 100, 
  fill_value_min = F_Harp_seal_mortality, 
  fill_value_max = Df_LoD_fixed_harp_seal_V10 %>% 
                                        filter(Fixed_LoD %in% c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 99)) %>%
                                        select(F_mortality_interpolated) %>%
                                        unlist(),
  output_file = here("Simulation_input", "Harp_seal_input_V10_simulation.csv"))

import_transformation_output_function_new("harp_seal", "V10", "F")

table_Df_merged_new_harp_seal_V10_F <- calculate_impact_summary(
  LoD_rename = c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 99),
  F_data = Df_merged_new_harp_seal_V10_F,
  species_unselect = c(5),
  species = "harp_seal",
  description = "number"
)

datatable(table_Df_merged_new_harp_seal_V10_F, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))


```


### Harp seal, Changes between V2 and V4

```{r seal_new_V2_V4, include=TRUE, echo=FALSE}

comparison_new_fig_harp_seal_V2_V4 <- compare_sensitivity(Df_merged_harp_seal_V2_F, Df_merged_new_harp_seal_V4_F)
plot_simulation_comparison(comparison_new_fig_harp_seal_V2_V4, "LoD", 11, " F harp seal Simulation: harp seal scenario V=2 vs V=4", group_name_key, sp_remove = c("Seal harp"),
                legend_labels = paste0("LoD ", c(0,10,20,30,40,50,60,70,80,90,99)))
datatable(comparison_new_fig_harp_seal_V2_V4, filter = "top", rownames = FALSE, options = list(pageLength = 5,  scrollX=T))

comparison_new_harp_seal_V2_V4 <- compare_sensitivity_analysis(table_Df_merged_harp_seal_V2_F, table_Df_merged_new_harp_seal_V4_F, "V2", "V4")
datatable(comparison_new_harp_seal_V2_V4$Comparison_by_cell, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```

### Harp seal, Changes between V2 and V10

```{r seal_new_V2_V10, include=TRUE, echo=FALSE}

comparison_new_fig_harp_seal_V2_V10 <- compare_sensitivity(Df_merged_harp_seal_V2_F, Df_merged_new_harp_seal_V10_F)
plot_simulation_comparison(comparison_new_fig_harp_seal_V2_V10, "LoD", 11, " F harp seal Simulation: harp seal scenario V=2 vs V=10", group_name_key, sp_remove = c("Seal harp"),
                legend_labels = paste0("LoD ", c(0,10,20,30,40,50,60,70,80,90,99)))
datatable(comparison_new_fig_harp_seal_V2_V4, filter = "top", rownames = FALSE, options = list(pageLength = 5,  scrollX=T))

comparison_new_harp_seal_V2_V10 <- compare_sensitivity_analysis(table_Df_merged_harp_seal_V2_F, table_Df_merged_new_harp_seal_V10_F, "V2", "V10")
datatable(comparison_new_harp_seal_V2_V10$Comparison_by_cell, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```


# Summary \& comparison vulnerability sensitivity approach 


## First approach {.tabset}

### Blank

### Cod

```{r cod_summary, include=TRUE, echo=FALSE}

datatable(table_Df_merged_cod_V2_F, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE), 
          caption = "Reference table (V=2)")

datatable(comparison_cod_V2_V4$Comparison_by_cell, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE),
           caption = "Comparison table between V=2 and V=4")
#datatable(comparison_cod_V2_V10, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

datatable(comparison_cod_V2_V4$Global_species_changes, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE),
           caption = "Addition or deletion of new species")

write_xlsx(table_Df_merged_cod_V2_F, here("results_tables", "reference_table_cod_V2.xlsx"))
write_xlsx(comparison_cod_V2_V4$Comparison_by_cell, here("results_tables", "comparison_cod_V2_V4_1st.xlsx"))
write_xlsx(comparison_cod_V2_V4$Global_species_changes, here("results_tables", "species_change_cod_V2_V4_1st.xlsx"))

```

### Capelin

```{r capelin_summary, include=TRUE, echo=FALSE}

datatable(table_Df_merged_capelin_V2_F, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE), 
          caption = "Reference table (V=2)")

datatable(comparison_capelin_V2_V4$Comparison_by_cell, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE),
           caption = "Comparison table between V=2 and V=4")
#datatable(comparison_capelin_V2_V10, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

datatable(comparison_capelin_V2_V4$Global_species_changes, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE),
           caption = "Addition or deletion of new species")

write_xlsx(table_Df_merged_capelin_V2_F, here("results_tables", "reference_table_capelin_V2.xlsx"))
write_xlsx(comparison_capelin_V2_V4$Comparison_by_cell, here("results_tables", "comparison_capelin_V2_V4_1st.xlsx"))
write_xlsx(comparison_capelin_V2_V4$Global_species_changes, here("results_tables", "species_change_capelin_V2_V4_1st.xlsx"))

```

### Harp seal 

```{r seal_summary, include=TRUE, echo=FALSE}

datatable(table_Df_merged_harp_seal_V2_F, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE), 
          caption = "Reference table (V=2)")

datatable(comparison_harp_seal_V2_V4$Comparison_by_cell, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE),
           caption = "Comparison table between V=2 and V=4")
#datatable(comparison_harp_seal_V2_V10, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

datatable(comparison_harp_seal_V2_V4$Global_species_changes, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE),
           caption = "Addition or deletion of new species")

write_xlsx(table_Df_merged_harp_seal_V2_F, here("results_tables", "reference_table_harp_seal_V2.xlsx"))
write_xlsx(comparison_harp_seal_V2_V4$Comparison_by_cell, here("results_tables", "comparison_harp_seal_V2_V4_1st.xlsx"))
write_xlsx(comparison_harp_seal_V2_V4$Global_species_changes, here("results_tables", "species_change_harp_seal_V2_V4_1st.xlsx"))

```

## Second approach {.tabset}

### Blank

### Cod

```{r cod_summary_2, include=TRUE, echo=FALSE}

datatable(table_Df_merged_cod_V2_F, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE), 
          caption = "Reference table (V=2)")

datatable(comparison_new_cod_V2_V4$Comparison_by_cell, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE),
           caption = "Comparison table between V=2 and V=4")
#datatable(comparison_new_cod_V2_V10, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

datatable(comparison_new_cod_V2_V4$Global_species_changes, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE),
           caption = "Addition or deletion of new species")

write_xlsx(comparison_new_cod_V2_V4$Comparison_by_cell, here("results_tables", "comparison_cod_V2_V4_2nd.xlsx"))
write_xlsx(comparison_new_cod_V2_V4$Global_species_changes, here("results_tables", "species_change_cod_V2_V4_2nd.xlsx"))

```

### Capelin

```{r capelin_summary_2, include=TRUE, echo=FALSE}

datatable(table_Df_merged_capelin_V2_F, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE), 
          caption = "Reference table (V=2)")

datatable(comparison_new_capelin_V2_V4$Comparison_by_cell, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE),
           caption = "Comparison table between V=2 and V=4")
#datatable(comparison_new_capelin_V2_V10, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

datatable(comparison_new_capelin_V2_V4$Global_species_changes, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE),
           caption = "Addition or deletion of new species")

write_xlsx(comparison_new_capelin_V2_V4$Comparison_by_cell, here("results_tables", "comparison_capelin_V2_V4_2nd.xlsx"))
write_xlsx(comparison_new_capelin_V2_V4$Global_species_changes, here("results_tables", "species_change_capelin_V2_V4_2nd.xlsx"))

```

### Harp seal 

```{r seal_summary_2, include=TRUE, echo=FALSE}

datatable(table_Df_merged_harp_seal_V2_F, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE), 
          caption = "Reference table (V=2)")

datatable(comparison_new_harp_seal_V2_V4$Comparison_by_cell, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE),
           caption = "Comparison table between V=2 and V=4")
#datatable(comparison_new_harp_seal_V2_V10, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

datatable(comparison_new_harp_seal_V2_V4$Global_species_changes, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE),
           caption = "Addition or deletion of new species")

write_xlsx(comparison_new_harp_seal_V2_V4$Comparison_by_cell, here("results_tables", "comparison_harp_seal_V2_V4_2nd.xlsx"))
write_xlsx(comparison_new_harp_seal_V2_V4$Global_species_changes, here("results_tables", "species_change_harp_seal_V2_V4_2nd.xlsx"))

```

## Species changes {.tabset}

### Blank

### Capelin 

```{r species_changes_capelin, include=TRUE, echo=FALSE}

Capelin_change <- c(13)
short_list <- group_name_key %>% filter(Group_number %in% c(Capelin_change))
print(short_list)

```

### Harp seal 

```{r species_changes_seal, include=TRUE, echo=FALSE}

Harp_seal_change <- c(25, 24)
short_list <- group_name_key %>% filter(Group_number %in% c(Harp_seal_change))
print(short_list)

```


# Level of Recovery - harp seal vulnerability sensitivity

For the new LoR, the approach is slightly different. As the LoR levels are estimated from a fixed reference value, this will not change with changes in vulnerability. So for these LoR levels, as in the first approach, we have simply run the Vajas et al. simulations with different levels of harp seal vulnerability (harp seal column as predator). The aim is to check the sensitivity of biomass forcing to changes in vulnerability.

## Vulnerability Sensitivity Analysis {.tabset}

### Blank 

### Cod simulation : B scenario V=2 versus V=4

```{r cod_B_2_4, include = TRUE, echo = FALSE}

comparison_cod_B_2_4 <- compare_sensitivity(Df_merged_cod_V2_B, Df_merged_cod_V4_B)

plot_simulation_comparison(comparison_cod_B_2_4, "LoR", 12, "B Cod Simulation: harp seal scenario V=2 vs V=4", group_name_key, sp_remove = c("Atlantic cod greater than 35cm", "Atlantic cod less than 35cm"),
                           legend_labels = paste0("LoR ", c(1,10,"obs", 20,30,40,50,60, 70,80,90,100)))

datatable(comparison_cod_B_2_4, filter="top", rownames = FALSE, options = list(pageLength = 5, scrollX=T))

```

### Cod simulation : B scenario V=2 versus V=10

```{r cod_B_2_10, include = TRUE, echo = FALSE}

comparison_cod_B_2_10 <- compare_sensitivity(Df_merged_cod_V2_B, Df_merged_cod_V10_B)

plot_simulation_comparison(comparison_cod_B_2_10, "LoR", 12, "B Cod Simulation: harp seal scenario V=2 vs V=10", group_name_key, sp_remove = c("Atlantic cod greater than 35cm", "Atlantic cod less than 35cm"),
                           legend_labels = paste0("LoR ", c(1,10,"obs", 20,30,40,50,60, 70,80,90,100)))

datatable(comparison_cod_B_2_10, filter="top", rownames = FALSE, options = list(pageLength = 5, scrollX=T))

```

### Caplin simulation : B scenario V=2 versus V=4

```{r capelin_B_2_4, include = TRUE, echo = FALSE}

comparison_capelin_B_2_4 <- compare_sensitivity(Df_merged_capelin_V2_B, Df_merged_capelin_V4_B)

plot_simulation_comparison(comparison_capelin_B_2_4, "LoR", 12, "B Capelin Simulation: harp seal scenario V=2 vs V=4", group_name_key, sp_remove = c("Capelin"),
                           legend_labels = paste0("LoR ", c(1,10,20,"obs", 30,40,50,60, 70,80,90,100)))

datatable(comparison_capelin_B_2_4, filter="top", rownames = FALSE, options = list(pageLength = 5, scrollX=T))

```

### Caplin simulation : B scenario V=2 versus V=10

```{r capelin_B_2_10, include = TRUE, echo = FALSE}

comparison_capelin_B_2_10 <- compare_sensitivity(Df_merged_capelin_V2_B, Df_merged_capelin_V10_B)

plot_simulation_comparison(comparison_capelin_B_2_10, "LoR", 12, "Capelin Simulation: B scenario V=2 vs V=10", group_name_key, sp_remove = c("Capelin"),
                           legend_labels = paste0("LoR ", c(1,10,20,"obs", 30,40,50,60, 70,80,90,100)))

datatable(comparison_capelin_B_2_10, filter="top", rownames = FALSE, options = list(pageLength = 5, scrollX=T))

```

## B Cod simulation : harp seal vulnerability change {.tabset}

### Blank 

### Default results V=2

```{r b_cod_defaut, include=TRUE, echo=FALSE}

table_Df_merged_cod_V2_LoR <- calculate_impact_summary_LoR(
  LoR_rename = c(1, 10, "obs", 20, 30, 40, 50, 60, 70, 80, 90, 100),
  F_data = Df_merged_cod_V2_B,
  species_unselect = c(12, 13),
  LoR_obs_position = "LoR_20", 
  species = "Cod",
  description = "number"
)

datatable(table_Df_merged_cod_V2_LoR, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

write_xlsx(table_Df_merged_cod_V2_LoR, here("results_tables", "reference_table_cod_V2_LoR.xlsx"))

```

### Results with V=4

```{r b_cod_V4, include=TRUE, echo=FALSE}

table_Df_merged_cod_V4_LoR <- calculate_impact_summary_LoR(
  LoR_rename = c(1, 10,  "obs", 20, 30, 40, 50, 60, 70, 80, 90, 100),
  F_data = Df_merged_cod_V2_B,
  species_unselect = c(12, 13),
  LoR_obs_position = "LoR_20", 
  species = "Cod",
  description = "number"
)

datatable(table_Df_merged_cod_V4_LoR, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```

### Results with V=10

```{r b_cod_V10, include=TRUE, echo=FALSE}

table_Df_merged_cod_V10_LoR <- calculate_impact_summary_LoR(
  LoR_rename = c(1, 10, "obs", 20, 30, 40, 50, 60, 70, 80, 90, 100),
  F_data = Df_merged_cod_V10_B,
  species_unselect = c(12, 13),
  LoR_obs_position = "LoR_20", 
  species = "Cod",
  description = "number"
)

datatable(table_Df_merged_cod_V10_LoR, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```

### Changes between V2 and V4

```{r b_cod_V2_V4, include=TRUE, echo=FALSE}

comparison_cod_V2_V4_LoR <- compare_sensitivity_analysis_LoR(table_Df_merged_cod_V2_LoR, table_Df_merged_cod_V4_LoR, "V2", "V4")
datatable(comparison_cod_V2_V4_LoR$Comparison_by_cell, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))
datatable(comparison_cod_V2_V4_LoR$Global_species_changes, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

write_xlsx(comparison_cod_V2_V4_LoR$Comparison_by_cell, here("results_tables", "comparison_cod_V2_V4_LoR.xlsx"))
write_xlsx(comparison_cod_V2_V4_LoR$Global_species_changes, here("results_tables", "species_change_cod_V2_V4_LoR.xlsx"))

```

### Changes between V2 and V10

```{r b_cod_V2_V10, include=TRUE, echo=FALSE}

comparison_cod_V2_V10_LoR <- compare_sensitivity_analysis_LoR(table_Df_merged_cod_V2_LoR, table_Df_merged_cod_V10_LoR, "V2", "V10")
datatable(comparison_cod_V2_V10_LoR$Comparison_by_cell, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))
datatable(comparison_cod_V2_V10_LoR$Global_species_changes, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))


```

## B capelin simulation : harp seal vulnerability change {.tabset}

### Blank 

### Default results V=2

```{r b_capelin_defaut, include=TRUE, echo=FALSE}

# Test avec tes données corrigées
table_Df_merged_capelin_V2_LoR <- calculate_impact_summary_LoR(
  LoR_rename = c(1, 10, 20, "obs", 30, 40, 50, 60, 70, 80, 90, 100),
  F_data = Df_merged_capelin_V2_B,
  species_unselect = c(31),
  LoR_obs_position = "LoR_30",
  species = "capelin",
  description = "number"
)

# Affichage interactif
datatable(table_Df_merged_capelin_V2_LoR, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

write_xlsx(table_Df_merged_capelin_V2_LoR, here("results_tables", "reference_table_capelin_V2_LoR.xlsx"))

```

### Results with V=4

```{r b_capelin_V4, include=TRUE, echo=FALSE}

# Test avec tes données corrigées
table_Df_merged_capelin_V4_LoR <- calculate_impact_summary_LoR(
  LoR_rename = c(1, 10, 20, "obs", 30, 40, 50, 60, 70, 80, 90, 100),
  F_data = Df_merged_capelin_V4_B,
  species_unselect = c(31),
  LoR_obs_position = "LoR_30",
  species = "capelin",
  description = "number"
)

# Affichage interactif
datatable(table_Df_merged_capelin_V4_LoR, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))


```

### Results with V=10

```{r b_capelin_V10, include=TRUE, echo=FALSE}

# Test avec tes données corrigées
table_Df_merged_capelin_V10_LoR <- calculate_impact_summary_LoR(
  LoR_rename = c(1, 10, 20, "obs", 30, 40, 50, 60, 70, 80, 90, 100),
  F_data = Df_merged_capelin_V10_B,
  species_unselect = c(31),
  LoR_obs_position = "LoR_30",
  species = "capelin",
  description = "number"
)

# Affichage interactif
datatable(table_Df_merged_capelin_V10_LoR, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```

### Changes between V2 and V4

```{r b_capelin_V2_V4, include=TRUE, echo=FALSE}

comparison_capelin_V2_V4_LoR <- compare_sensitivity_analysis_LoR(table_Df_merged_capelin_V2_LoR, table_Df_merged_capelin_V4_LoR, "V2", "V4")
datatable(comparison_capelin_V2_V4_LoR$Comparison_by_cell, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))
datatable(comparison_capelin_V2_V4_LoR$Global_species_changes, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

write_xlsx(comparison_capelin_V2_V4_LoR$Comparison_by_cell, here("results_tables", "comparison_capelin_V2_V4_LoR.xlsx"))
write_xlsx(comparison_capelin_V2_V4_LoR$Global_species_changes, here("results_tables", "species_change_capelin_V2_V4_LoR.xlsx"))

```

### Changes between V2 and V10

```{r b_capelin_V2_V10, include=TRUE, echo=FALSE}

comparison_capelin_V2_V10_LoR <- compare_sensitivity_analysis_LoR(table_Df_merged_capelin_V2_LoR, table_Df_merged_capelin_V10_LoR, "V2", "V10")
datatable(comparison_capelin_V2_V10_LoR$Comparison_by_cell, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))
datatable(comparison_capelin_V2_V10_LoR$Global_species_changes, filter = "top", rownames = FALSE, options = list(pageLength = 12, scrollX = TRUE))

```

## Species change {.tabset}

### Blank

### Capelin

```{r species_changes_LoR_capelion, include=TRUE, echo=FALSE}

Capelin_change <- c(28, 35)

short_list <- group_name_key %>% filter(Group_number %in% c(Capelin_change))
print(short_list)

```

