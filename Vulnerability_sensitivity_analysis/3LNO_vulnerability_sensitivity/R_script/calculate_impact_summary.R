calculate_impact_summary <- function(LoD_rename, F_data, species_unselect, species, description = "name") {
  
  # Étape 1 : Filtrer les données pour retirer l'espèce sélectionnée
  df_filtered <- F_data %>%
    filter(!(Group_number %in% species_unselect))
  
  # Extraire les noms et numéros des espèces
  species_names <- df_filtered$Group_name
  species_numbers <- df_filtered$Group_number
  
  # Supprimer la colonne Group_number pour la suite des calculs
  df_filtered <- df_filtered %>% select(-Group_number)
  
  # Étape 2 : Convertir en numérique uniquement les colonnes LoD_xx
  df_numeric <- df_filtered %>%
    select(-Group_name) %>%
    mutate(across(everything(), as.numeric))
  
  # Étape 3 : Calcul des pourcentages de changement par rapport à LoD_0
  column_names <- paste0("LoD_", LoD_rename)
  colnames(df_numeric) <- column_names  # Renommer correctement
  
  percentage_changes <- df_numeric %>%
    mutate(across(-LoD_0, ~ ((. - LoD_0) / abs(LoD_0)) * 100)) %>%
    select(-LoD_0)  # Retirer la colonne de référence
  
  # Étape 4 : Détection des espèces impactées
  get_impacted_species <- function(df, threshold, sign) {
    df_change <- df %>%
      mutate(across(everything(), ~ case_when(
        . >= threshold & sign == "pos" ~ "+",
        . <= -threshold & sign == "neg" ~ "-",
        TRUE ~ "no"
      )))
    
    impacted_list <- lapply(names(df_change), function(col) {
      impacted <- species_names[df_change[[col]] %in% c("+", "-")]
      if (length(impacted) == 0) impacted <- "No change"
      return(paste(impacted, collapse = "; "))  # Séparateur ";"
    })
    
    return(impacted_list)
  }
  
  # Étape 5 : Création du tableau récapitulatif
  result_table <- tibble(
    `LoD simulation` = c("LoD_0 (baseline)", names(percentage_changes)),
    `20% change -` = c("No change", get_impacted_species(percentage_changes, 20, "neg")),
    `20% change +` = c("No change", get_impacted_species(percentage_changes, 20, "pos")),
    `40% change -` = c("No change", get_impacted_species(percentage_changes, 40, "neg")),
    `40% change +` = c("No change", get_impacted_species(percentage_changes, 40, "pos"))
  )
  
  # Étape 6 : Conversion des noms en numéros si description == "number"
  if (description == "number") {
    # Création d'un mapping nom -> numéro
    name_to_number <- setNames(species_numbers, species_names)
    
    # Fonction pour remplacer les noms par les numéros
    convert_to_numbers <- function(species_string) {
      if (species_string == "No change") return(species_string)
      species_vector <- unlist(strsplit(species_string, "; "))
      number_vector <- unname(name_to_number[species_vector])
      return(paste(number_vector, collapse = "; "))
    }
    
    # Appliquer la conversion sur toutes les colonnes contenant des espèces
    result_table <- result_table %>%
      mutate(across(-`LoD simulation`, ~ sapply(., convert_to_numbers)))
  }
  
  # Retourner le tableau final
  return(result_table)
}
